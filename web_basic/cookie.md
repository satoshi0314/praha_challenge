# cookie

[課題](https://airtable.com/tblg8ePOEQRDtIGiY/viwV3pAlEvPOOgmHF/recnvcBSsaC2n0kuI?blocks=hide)

## 課題 1

### Cookie とは

サーバが`Set-Cookie`というレスポンスヘッダを用いてユーザーが使用しているブラウザに任意の値を渡すものです。
この`Set-Cookie`に指定された値は、ブラウザに保存され、再度同じサーバにリクエストする際に、`Cookie`ヘッダに設定されて送られます。
Cookie を利用してクライアントとサーバー間でユーザーの状態を維持・管理し、ステートレスな HTTP でも状態管理を実現することが可能になります。

### ドメインを跨ぐクッキー

クッキーを設定したドメインと異なるドメインに対するリクエストにはクッキーは送信されません。
ただし、`Set-Cookie`で`Domain`属性を設定することで異なるドメインに対するリクエストにもクッキーを送信することが可能です。

### ポートを跨ぐクッキー

送信される。

> cookies for a given host are shared
> across all the ports on that host, even though the usual "same-origin
> policy" used by web browsers isolates content retrieved via different ports.
> ref: https://datatracker.ietf.org/doc/html/rfc6265

### サブドメインを跨ぐクッキー

クッキーを設定したドメインと異なるドメインに対するリクエストにはクッキーは送信されません。
ただし、`Set-Cookie`で`Domain`属性を設定することで異なるドメインに対するリクエストにもクッキーを送信することが可能になり、この時、サブドメインも含まれるようになり、制限が緩和され、送信することが可能になる。

### クッキーに Domain="hoge.com"を指定した場合、api.hoge.com にもクッキーは送信されるでしょうか？理由を説明してください

Domain を指定すると省略時よりも制限が緩和され、サブドメインも含まれるようになるため。

### JavaScript から Cookie を取得させない方法

`HttpOnly`属性を設定する

```
Set-Cookie: hoge=fuga; HttpOnly
```

### HTTPS（暗号化）通信の時だけクッキーを送信する方法

`Secure`属性を設定する

```
Set-Cookie: hoge=fuga; Secure
```

### Expires を設定した時の挙動

Expires を設定しなかった場合、ブラウザを閉じるまでがクッキーのゆうこうきげんとなる。
Expires を設定した場合、設定された日時がクッキーの有効期限となる。
ただし、`Max-Age`も設定されていた場合、`Max-Age`が優先される。

### SameSite 属性

SameSite 属性により、サーバーがオリジン間リクエストと一緒にクッキーを送るべきかどうかを指定することができる設定。設定できる値は `Strict`, `Lax`, `None` の 3 つ。

- Strict
  - same-site のリクエストに対してのみ、クッキーを送信する。
- Lax
  - 画像やフレームをロードするための呼び出しなどのクロスサイトサブリクエストではクッキーが抑止されますが、ユーザーがリンクをクリックするなどして外部サイトから URL に移動すると送信されます。
    - アドレスバーに表示されている URL の変更が伴う遷移で、且つ GET メソッドであれば、他のドメインへのリクエストであってもクッキーをセットします。
    - A サイトでログイン中だった場合に、B サイト上に用意された A サイトへのリンクをクリックした場合、ログイン状態でページの遷移が行われます。
    - POST メソッドを使ったフォーム、img タグ、iframe、XMLHttpRequests などによる他ドメインへのリクエストにはクッキーはセットされません。
- None
  - ブラウザはクロスサイトと same-site の両方のリクエストでクッキーを送信する。

> ref https://laboradian.com/same-site-cookies/

### クッキーに格納しない方が良い情報の例を、3 つ以上挙げてください

- 個人情報
- 暗号化されていない生の情報

### クッキーはローカルストレージと混同されることが多々あります。クッキーを使うべきタイミングと、ローカルストレージを使うべきタイミングを挙げてみてください

- クッキーにはサーバーとのやりとりで、状態を管理する情報を持たせるべき
  - ユーザのログインに関するセッション情報
- ローカルストレージには、サーバーと通信しないので、ブラウザ側で完結するような情報を持たせるべき（Javascript からアクセス可能）
  - 見た目の設定
  - 閲覧した商品
  - クライアント側の使用状況をまとめてサーバーに送信するための一時保管（e.g. エラー ID をまとめてログサーバーに送信）
  - サーバーとのデータ不整合を防止するためのバージョン情報

### stack overflow のような WEB 掲示板サービスを開発しているとしましょう。XSS（クロスサイトスクリプティング）により、他ユーザのクッキー情報が抜き出される仕組みを説明してください。どのような対策が考えられますか？

仕込んだスクリプトからブラウザに保存されている cookie にアクセスする。
対策として、HttpOnly を設定して、Javascript から取得できないようにする。
投稿した内容に不正なスクリプトが含まれていないかチェックを行い、その投稿を出力する時にサニタイズする

## 課題２（クイズ）

- `__Host-` Cookie 名にこの接頭辞がついている場合、そのクッキーはどのようなものでしょうか。

- ログインセッションを管理するためにクッキーにセッション ID を入れているウェブサイト A があります。
  ウェブサイト A から新商品の広告のメールがきました。そのメールに含まれるウェブサイト A へのリンクからアクセスした時、もしクッキーに Same-Site を Strict に設定しているクッキーは送信されるでしょうか。

- web サービスは世界中のどこからでもアクセスすることができます。しかし各地域によっては web サービスに関する規制が異なります。その中でもクッキーの使用を対象とした法規制がありますが、何があるでしょうか。
